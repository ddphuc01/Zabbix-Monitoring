---
# Restart Windows Service via WinRM
# Usage: ansible-playbook restart_service.yml -e "target_host=WIN-PC-129 service_name=Spooler"

- name: Restart Windows Service
  hosts: "{{ target_host | default('all') }}"
  gather_facts: no
  
  vars:
    service_name: "{{ service_name | default('') }}"
  
  tasks:
    - name: Validate service name provided
      fail:
        msg: "service_name variable is required"
      when: service_name == ''
    
    - name: Get service status before restart
      win_service_info:
        name: "{{ service_name }}"
      register: service_info_before
      
    - name: Check if service exists
      fail:
        msg: "Service '{{ service_name }}' not found on {{ inventory_hostname }}"
      when: service_info_before.services | length == 0
    
    - name: Restart Windows service
      win_service:
        name: "{{ service_name }}"
        state: restarted
      register: restart_result
      
    - name: Wait for service to start
      win_service_info:
        name: "{{ service_name }}"
      register: service_status
      until: service_status.services[0].state == 'running'
      retries: 10
      delay: 2
      
    - name: Display result
      debug:
        msg: |
          Service: {{ service_name }}
          Previous State: {{ service_info_before.services[0].state }}
          Current State: {{ service_status.services[0].state }}
          Start Mode: {{ service_status.services[0].start_mode }}
          Status: Successfully restarted
