---
# Post-Installation Zabbix Configuration
# This playbook configures Zabbix after initial deployment:
# 1. Fix "Zabbix server" host interface (127.0.0.1 -> zabbix-agent2)
# 2. Configure AI webhook integration
# 3. Ensure monitoring is operational

- name: Configure Zabbix Post-Installation
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    zabbix_url: "{{ lookup('env', 'ZABBIX_URL') | default('http://localhost:8080', true) }}"
    zabbix_api_user: "{{ lookup('env', 'ZABBIX_API_USER') | default('Admin', true) }}"
    zabbix_api_password: "{{ lookup('env', 'ZABBIX_API_PASSWORD') | default('zabbix', true) }}"
    
  tasks:
    - name: Wait for Zabbix API to be ready
      uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "apiinfo.version"
          id: 1
          params: {}
        status_code: 200
      register: api_check
      retries: 30
      delay: 10
      until: api_check.status == 200
      changed_when: false

    - name: Display Zabbix API version
      debug:
        msg: "Zabbix API version: {{ api_check.json.result }}"

    - name: Update Zabbix server host interface to use Docker container name
      community.zabbix.zabbix_host:
        server_url: "{{ zabbix_url }}"
        login_user: "{{ zabbix_api_user }}"
        login_password: "{{ zabbix_api_password }}"
        host_name: "Zabbix server"
        interfaces:
          - type: agent
            main: 1
            useip: 0  # Use DNS instead of IP
            dns: zabbix-agent2
            ip: ""
            port: 10050
        state: present
      register: zabbix_host_update
      
    - name: Display interface update result
      debug:
        msg: "Zabbix server interface updated to use 'zabbix-agent2' container"
      when: zabbix_host_update.changed

    - name: Wait for agent connection to establish
      pause:
        seconds: 15
        prompt: "Waiting for Zabbix Agent to connect..."
      when: zabbix_host_update.changed


    - name: Create 'AI Webhook (Groq)' Media Type
      community.zabbix.zabbix_mediatype:
        server_url: "{{ zabbix_url }}"
        login_user: "{{ zabbix_api_user }}"
        login_password: "{{ zabbix_api_password }}"
        name: "AI Webhook (Groq)"
        type: webhook
        status: enabled
        script: |
          var params = JSON.parse(value);
          var req = new HttpRequest();
          req.addHeader('Content-Type: application/json');

          var payload = JSON.stringify({
              trigger_name: params.trigger_name,
              host_name: params.host_name,
              trigger_severity: params.trigger_severity,
              trigger_value: params.trigger_value,
              event_time: params.event_time,
              trigger_description: params.trigger_description,
              event_id: params.event_id
          });

          var response = req.post('http://ai-webhook:5000/webhook', payload);

          if (req.getStatus() !== 200) {
              throw 'Webhook failed: ' + response;
          }

          return 'OK';
        parameters:
          - name: trigger_name
            value: "{ALERT.SUBJECT}"
          - name: host_name
            value: "{HOST.NAME}"
          - name: trigger_severity
            value: "{TRIGGER.SEVERITY}"
          - name: trigger_value
            value: "{ITEM.VALUE}"
          - name: event_time
            value: "{EVENT.TIME}"
          - name: trigger_description
            value: "{TRIGGER.DESCRIPTION}"
          - name: event_id
            value: "{EVENT.ID}"
      register: webhook_create

    - name: Display media type creation result
      debug:
        msg: "Media Type 'AI Webhook (Groq)' created/updated"
      when: webhook_create.changed

    - name: Assign 'AI Webhook (Groq)' to Admin user
      community.zabbix.zabbix_user:
        server_url: "{{ zabbix_url }}"
        login_user: "{{ zabbix_api_user }}"
        login_password: "{{ zabbix_api_password }}"
        alias: "{{ zabbix_api_user }}"
        usrgrps: 
          - Zabbix administrators
        media:
          - active: false  # Existing Email (disable or keep)
            mediatype: Email
            sendto: "admin@example.com"
          - active: true
            mediatype: "AI Webhook (Groq)"
            sendto: "ai-webhook"
            period: "1-7,00:00-24:00"
            severity:
              - not_classified
              - information
              - warning
              - average
              - high
              - disaster
      register: user_update

    - name: Create 'AI Alert with Telegram' Trigger Action
      community.zabbix.zabbix_action:
        server_url: "{{ zabbix_url }}"
        login_user: "{{ zabbix_api_user }}"
        login_password: "{{ zabbix_api_password }}"
        name: "AI Alert with Telegram"
        status: enabled
        eventsource: trigger
        operations:
          - operationtype: send_message
            subject: "{TRIGGER.STATUS}: {TRIGGER.NAME}"
            message: "Problem started at {EVENT.TIME} on {EVENT.DATE}\nHost: {HOST.NAME}\nSeverity: {TRIGGER.SEVERITY}\nValue: {ITEM.VALUE}"
            mediatype: "AI Webhook (Groq)"
            sendto_users:
              - Admin
        filter:
          conditions:
            - type: trigger_severity
              operator: ">="
              value: average  # High or Average
      register: action_create

    - name: Display completion message
      debug:
        msg: |
          ========================================
          âœ… Zabbix Post-Install Configuration Complete!
          ========================================
          
          1. Server Host Interface: FIXED (DNS: zabbix-agent2)
          2. Media Type: CREATED (AI Webhook (Groq))
          3. User Media: ASSIGNED (Admin -> AI Webhook)
          4. Action: CREATED (AI Alert with Telegram)
          
          Next steps:
          1. Open Zabbix UI: {{ zabbix_url }}
          2. Verify alerts by running a test trigger
          3. Check Telegram for notifications
          
          ========================================

